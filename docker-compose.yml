services:
  init-permissions:
    image: alpine:latest
    container_name: searchpy-init-permissions-dev
    volumes:
      - ./logs:/logs
    command: >
      sh -c "
        echo 'üîß V√©rification des permissions du dossier logs...'
        mkdir -p /logs
        chmod 777 /logs
        chown -R 1000:1000 /logs
        echo '‚úÖ Permissions corrig√©es !'
      "
    restart: "no" # S'ex√©cute une seule fois au d√©marrage
  searchpy:
    build: .
    command: uvicorn app.main:app --host 0.0.0.0 --reload
    container_name: searchpy-app-dev
    ports:
      - "8000:8000"
    volumes:
      - ./logs:/app/logs
    env_file:
      - .env
    # Sp√©cifie l'utilisateur pour √©viter les probl√®mes de permissions
    # user: "1000:1000"  # D√©commente si ton app peut tourner en non-root
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import sys, http.client; conn = http.client.HTTPConnection(\"localhost\", 8000); conn.request(\"GET\", \"/health\"); sys.exit(0) if conn.getresponse().status == 200 else sys.exit(1)"',
        ]
      interval: 10s
      timeout: 5s
      retries: 2
      start_period: 10s
    depends_on:
      init-permissions:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - search_api_network
    labels:
      - "autoheal=true"

  redis:
    image: redis:7-alpine
    container_name: searchpy-redis-dev
    # S√âCURIT√â : Redis n'est accessible que depuis l'int√©rieur du r√©seau Docker
    # Si tu as besoin d'y acc√©der depuis l'ext√©rieur, d√©commente :
    # ports:
    #   - "127.0.0.1:6379:6379"  # Accessible uniquement en localhost
    command: redis-server --save "" --appendonly no --maxmemory 512mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - search_api_network
    labels:
      - "autoheal=true"

networks:
  search_api_network:
    driver: bridge
